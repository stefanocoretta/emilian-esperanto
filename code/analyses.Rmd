---
title: "Analyses"
author: "Stefano Coretta"
date: "10/09/2021"
output:
  html_document:
    number_sections: true
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here::here())
library(tidyverse)
theme_set(theme_light())
library(FactoMineR)
library(factoextra)
library(brms)
```

# Read data

```{r data}
headings_em <- read_csv("data/raw/headings-emilian.csv")
headings_eo <- read_csv("data/raw/headings-esperanto.csv")

emilian <- read_csv("data/raw/emilian-clean.csv", skip = 1, col_names = headings_em$new, na = c("", "NA", "na")) %>%
  mutate(
    understand = factor(understand, levels = c("NO", "AL", "50/50", "G", "VG")),
    speak = factor(speak, levels = c("NO", "AL", "50/50", "G", "VG"))
  )

esperanto <- read_csv("data/raw/esperanto-clean.csv", skip = 1, col_names = headings_eo$new, na = c("", "NA", "na")) %>%
  mutate(
    age = str_remove(age, "jaroj"),
    age = str_replace(age, "naskiĝis en la 1995a", "25"),
    age = as.numeric(age),
    understand = factor(understand, levels = c("NO", "AL", "50/50", "G", "VG")),
    speak = factor(speak, levels = c("NO", "AL", "50/50", "G", "VG"))
  )
```

# Emilian

## Participants

```{r em-gender}
emilian %>%
  ggplot(aes(gender)) +
  geom_bar()
```

```{r em-age}
emilian %>%
  ggplot(aes(age)) +
  geom_histogram()

emilian %>%
  ggplot(aes(age)) +
  geom_density()
```

```{r em-education}
emilian %>%
  ggplot(aes(education)) +
  geom_bar()
```

```{r em-age-edu}
emilian %>%
  ggplot(aes(age, education)) +
  geom_jitter(height = 0.2, alpha = 0.5)
```

```{r em-occupation}
emilian %>%
  count(profession) %>%
  ggplot(aes(reorder(profession, -n), n)) +
  geom_bar(stat = "identity")
```

```{r em-languages-family}
emilian %>%
  count(languages_family) %>%
  ggplot(aes(reorder(languages_family, -n), n)) +
  geom_bar(stat = "identity")
```

```{r em-languages-parents}
emilian %>%
  count(languages_parents) %>%
  ggplot(aes(reorder(languages_parents, -n), n)) +
  geom_bar(stat = "identity")
```

## Language

### Understand

```{r em-understand}
emilian %>%
  ggplot(aes(understand, fill = understand)) +
  geom_bar() +
  scale_fill_brewer(type = "div") +
  theme_dark()
```

```{r em-understand-gender}
emilian %>%
  ggplot(aes(understand, fill = gender)) +
  geom_bar()

emilian %>%
  ggplot(aes(understand, fill = gender)) +
  geom_bar(position = "fill")
```

```{r em-understand-age}
emilian %>%
  ggplot(aes(age, fill = understand)) +
  geom_histogram(binwidth = 5) +
  facet_grid(understand ~ .)
```

```{r em-understand-profession}
emilian %>%
  ggplot(aes(understand, fill = profession)) +
  geom_bar()

emilian %>%
  ggplot(aes(understand, fill = profession)) +
  geom_bar(position = "fill")
```

### Speak

```{r em-speak}
emilian %>%
  ggplot(aes(speak, fill = speak)) +
  geom_bar() +
  scale_fill_brewer(type = "div")
```

```{r em-speak-gender}
emilian %>%
  ggplot(aes(speak, fill = gender)) +
  geom_bar()

emilian %>%
  ggplot(aes(speak, fill = gender)) +
  geom_bar(position = "fill")
```

```{r em-speak-age}
esperanto %>%
  ggplot(aes(age, fill = speak)) +
  geom_histogram(binwidth = 5) +
  facet_grid(speak ~ .)
```

```{r em-speak-profession}
emilian %>%
  ggplot(aes(speak, fill = profession)) +
  geom_bar()

emilian %>%
  ggplot(aes(speak, fill = profession)) +
  geom_bar(position = "fill")
```



### Read and write

```{r em-read-write}
emilian %>%
  ggplot(aes(read_write, fill = read_write)) +
  geom_bar()
```

```{r em-read-write-gender}
emilian %>%
  ggplot(aes(read_write, fill = gender)) +
  geom_bar()

emilian %>%
  ggplot(aes(read_write, fill = gender)) +
  geom_bar(position = "fill")
```

```{r em-read-write-age}
emilian %>%
  drop_na(read_write) %>% 
  ggplot(aes(age, fill = read_write)) +
  geom_histogram(binwidth = 5) +
  facet_grid(read_write ~ .)
```

```{r em-read-write-profession}
emilian %>%
  ggplot(aes(read_write, fill = profession)) +
  geom_bar()

emilian %>%
  ggplot(aes(read_write, fill = profession)) +
  geom_bar(position = "fill")
```




### Attitude

```{r em-attitude}
emilian %>%
  select(educated:familiar) %>%
  pivot_longer(educated:familiar, names_to = "feature", values_to = "rating") %>%
  ggplot(aes(as.factor(rating), fill = as.factor(rating))) +
  geom_bar() +
  scale_fill_brewer() +
  facet_grid(. ~ feature)

emilian %>%
  select(educated:familiar) %>%
  pivot_longer(educated:familiar, names_to = "feature", values_to = "rating") %>%
  ggplot(aes(feature, fill = as.factor(rating))) +
  geom_bar(position = "fill") +
  scale_fill_brewer()
```


# Esperanto: Descriptive

## Participants

```{r eo-gender}
esperanto %>%
  ggplot(aes(gender)) +
  geom_bar()
```

```{r eo-age}
esperanto %>%
  ggplot(aes(age)) +
  geom_histogram()

esperanto %>%
  ggplot(aes(age)) +
  geom_density()
```

```{r eo-education}
esperanto %>%
  ggplot(aes(education)) +
  geom_bar()
```

```{r eo-age-edu}
esperanto %>%
  ggplot(aes(age, education)) +
  geom_jitter(height = 0.2, alpha = 0.5)
```

```{r eo-occupation}
esperanto %>%
  count(profession) %>%
  ggplot(aes(reorder(profession, -n), n)) +
  geom_bar(stat = "identity")
```

```{r eo-languages-family}
esperanto %>%
  count(languages_family) %>%
  ggplot(aes(reorder(languages_family, -n), n)) +
  geom_bar(stat = "identity")
```


## Language

### Understand

```{r eo-understand}
esperanto %>%
  ggplot(aes(understand, fill = understand)) +
  geom_bar() +
  scale_fill_brewer(type = "div") +
  theme_dark()
```

```{r eo-understand-gender}
esperanto %>%
  ggplot(aes(understand, fill = gender)) +
  geom_bar()

esperanto %>%
  ggplot(aes(understand, fill = gender)) +
  geom_bar(position = "fill")
```

```{r eo-understand-age}
esperanto %>%
  ggplot(aes(age, fill = understand)) +
  geom_histogram(binwidth = 5) +
  facet_grid(understand ~ .)
```

```{r eo-understand-profession}
esperanto %>%
  ggplot(aes(understand, fill = profession)) +
  geom_bar()

esperanto %>%
  ggplot(aes(understand, fill = profession)) +
  geom_bar(position = "fill")
```


### Speak

```{r eo-speak}
esperanto %>%
  ggplot(aes(speak, fill = speak)) +
  geom_bar() +
  scale_fill_brewer(type = "div")
```


```{r eo-speak-gender}
esperanto %>%
  ggplot(aes(speak, fill = gender)) +
  geom_bar()

esperanto %>%
  ggplot(aes(speak, fill = gender)) +
  geom_bar(position = "fill")
```

```{r eo-speak-age}
esperanto %>%
  ggplot(aes(age, fill = speak)) +
  geom_histogram(binwidth = 5) +
  facet_grid(speak ~ .)
```

```{r eo-speak-profession}
esperanto %>%
  ggplot(aes(speak, fill = profession)) +
  geom_bar()

esperanto %>%
  ggplot(aes(speak, fill = profession)) +
  geom_bar(position = "fill")
```

### Read and write

```{r eo-read-write}
esperanto %>%
  ggplot(aes(read_write, fill = read_write)) +
  geom_bar()
```


### Attitude

```{r eo-attitude}
esperanto %>%
  select(educated:familiar) %>%
  pivot_longer(educated:familiar, names_to = "feature", values_to = "rating") %>%
  drop_na() %>%
  ggplot(aes(as.factor(rating), fill = as.factor(rating))) +
  geom_bar() +
  scale_fill_brewer() +
  facet_grid(. ~ feature)

esperanto %>%
  select(educated:familiar) %>%
  pivot_longer(educated:familiar, names_to = "feature", values_to = "rating") %>%
  drop_na() %>%
  ggplot(aes(feature, fill = as.factor(rating))) +
  geom_bar(position = "fill") +
  scale_fill_brewer()
```




# Modelling

```{r lang-use-data}
lang_use <- bind_rows(
  emilian %>% mutate(language = "emilian"),
  esperanto %>% mutate(language = "esperanto")
) %>%
  select(id, understand, speak, read_write, language, educated:familiar) %>%
  mutate(
    understand = ordered(understand, levels = c("NO", "AL", "50/50", "G", "VG")),
    speak = ordered(speak, levels = c("NO", "AL", "50/50", "G", "VG")),
    across(educated:familiar, ~ as.ordered(.x))
  ) %>%
 drop_na()

attitudes <- lang_use %>%
  select(educated:familiar)
```

## MCA

```{r attitudes-mca}
attitudes_mca <- MCA(attitudes, graph = FALSE)
attitudes_dims <- attitudes_mca[["ind"]][["coord"]]
```

```{r screeplot}
fviz_screeplot(attitudes_mca, addlabels = TRUE, ylim = c(0, 15))
fviz_mca_biplot(attitudes_mca, repel = TRUE)
```

```{r mca-cor}
fviz_mca_var(attitudes_mca, choice = "mca.cor", repel = TRUE)
```

```{r mca-var}
fviz_mca_var(attitudes_mca, col.var = "black", shape.var = 15, repel = TRUE)
```

```{r mca-var-cos2}
fviz_mca_var(attitudes_mca, col.var = "cos2", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), repel = TRUE)
```

```{r mca-cos2}
fviz_cos2(attitudes_mca, choice = "var", axes = 1:2)
```


```{r mca-contrib}
fviz_contrib(attitudes_mca, choice = "var", axes = 1, top = 15)
fviz_contrib(attitudes_mca, choice = "var", axes = 2, top = 15)
fviz_contrib(attitudes_mca, choice = "var", axes = 1:2, top = 15)
```

```{r mca-ind}
fviz_mca_ind(attitudes_mca, label = "none", habillage = "trustworthy")
fviz_mca_ind(attitudes_mca, label = "none", habillage = "friendly")
fviz_mca_ind(attitudes_mca, label = "none", habillage = "kind")
fviz_mca_ind(attitudes_mca, label = "none", habillage = "familiar")
```




## Understand

```{r dim-1}
lang_use$dim_1 <- -attitudes_dims[, 1]
```

```{r understand-bm-prior}
get_prior(
  understand ~
    language * dim_1,
  data = lang_use,
  family = cumulative()
)

understand_priors <- c(
  prior(normal(0, 3), class = Intercept),
  prior(normal(0, 1), class = b)
)

understand_pchek <- brm(
  understand ~
    language * dim_1,
  data = lang_use,
  family = cumulative(),
  prior = understand_priors,
  sample_prior = "only",
  backend = "cmdstanr",
  cores = 4,
  file = "./data/rds/understand_pchek"
)

conditional_effects(understand_pchek, effects = "dim_1", conditions = make_conditions(lang_use, "language"), categorical = TRUE)
```


```{r understand-bm}
understand_bm <- brm(
  understand ~
    language * dim_1,
  data = lang_use,
  family = cumulative(),
  prior = understand_priors,
  backend = "cmdstanr",
  cores = 4,
  file = "./data/rds/understand_bm"
)
```

```{r understand-bm-cond}
conditional_effects(understand_bm, effects = "dim_1", categorical = TRUE, conditions = make_conditions(lang_use, "language"))
```

## Speak

```{r speak-bm}
speak_bm <- brm(
  speak ~
    language * dim_1,
  data = lang_use,
  family = cumulative(),
  # Same priors as understand_bm
  prior = understand_priors,
  backend = "cmdstanr",
  cores = 4,
  file = "./data/rds/speak_bm"
)
```

```{r speak-bm-cond}
conditional_effects(speak_bm, effects = "dim_1", categorical = TRUE, conditions = make_conditions(speak_bm, "language"))
```

## Read and write

```{r rw-bm}
rw_bm <- brm(
  read_write ~
    language * dim_1,
  data = lang_use,
  family = bernoulli(),
  # Same priors as understand_bm
  prior = understand_priors,
  backend = "cmdstanr",
  cores = 4,
  file = "./data/rds/rw_bm"
)
```

```{r rw-bm-cond}
conditional_effects(rw_bm, effects = "dim_1:language")
```
